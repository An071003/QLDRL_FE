'use client';

import { useEffect, useState, useRef, useCallback } from 'react';
import { useParams, useRouter } from 'next/navigation';
import api from '@/lib/api';
import Loading from '@/components/Loading';
import { toast } from 'sonner';
import { Table, Tag, Input, Button, Modal, Checkbox } from 'antd';
import type { ColumnsType } from 'antd/es/table';
import debounce from 'lodash.debounce';
import { Activity } from "@/types/activity";
import ConfirmDeleteModal from '@/components/ConfirmDeleteModal';

interface StudentActivity {
  id: number;
  student_id: string;
  student_name: string;
  class?: string;
  faculty?: string;
  participated: boolean;
}

export default function DPOActivityStudentsPage() {
  const params = useParams();
  const router = useRouter();
  const activityId = Array.isArray(params.id) ? params.id[0] : params.id;
  const [students, setStudents] = useState<StudentActivity[]>([]);
  const [loading, setLoading] = useState(true);
  const [activity, setActivity] = useState<Activity | null>(null);
  const [search, setSearch] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [canEdit, setCanEdit] = useState(false);
  const tableRef = useRef<HTMLDivElement>(null);
  
  // Modal states for registering new students
  const [registerModalVisible, setRegisterModalVisible] = useState(false);
  const [availableStudents, setAvailableStudents] = useState<StudentActivity[]>([]);
  const [selectedStudents, setSelectedStudents] = useState<string[]>([]);
  const [loadingAvailableStudents, setLoadingAvailableStudents] = useState(false);
  const [searchStudent, setSearchStudent] = useState("");
  
  // Confirm modal for removing students
  const [confirmDeleteOpen, setConfirmDeleteOpen] = useState(false);
  const [studentIdToDelete, setStudentIdToDelete] = useState<string | null>(null);

  const fetchData = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      // Fetch activity details
      const activityRes = await api.get(`/api/activities/${activityId}`);
      
      if (!activityRes.data || !activityRes.data.data || !activityRes.data.data.activity) {
        throw new Error('Invalid activity data response');
      }
      
      const activityData = activityRes.data.data.activity;
      console.log('Activity data:', activityData);
      
      setActivity(activityData);
      
      // X√°c ƒë·ªãnh n·∫øu c√≥ th·ªÉ ch·ªânh s·ª≠a
      if (activityData.status === 'ongoing' && activityData.approver_id !== null) {
        const currentDate = new Date();
        const registrationStart = activityData.registration_start ? new Date(activityData.registration_start) : null;
        const registrationEnd = activityData.registration_end ? new Date(activityData.registration_end) : null;
        
        if (registrationStart && registrationEnd && 
            currentDate >= registrationStart && 
            currentDate <= registrationEnd) {
          setCanEdit(true);
        }
      }

      // Only fetch students if the activity exists
      if (activityData.approver_id !== null) {
        try {
          const studentsRes = await api.get(`/api/student-activities/${activityId}`);
          setStudents(studentsRes.data.data.students || []);
        } catch (err) {
          console.error('Failed to fetch students:', err);
          // Don't fail the whole page if just student data fails
          setStudents([]);
          toast.error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu sinh vi√™n');
        }
      }
    } catch (err) {
      console.error('Failed to fetch activity data:', err);
      setError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ho·∫°t ƒë·ªông');
      toast.error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ho·∫°t ƒë·ªông');
    } finally {
      setLoading(false);
    }
  }, [activityId]);

  useEffect(() => {
    fetchData();
  }, [activityId, fetchData]);

  const debouncedSearch = debounce((value: string) => {
    setSearch(value);
  }, 300);

  const handleSearchChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    debouncedSearch(e.target.value);
  };

  const filtered = students.filter(s => 
    s.student_id?.toLowerCase().includes(search.toLowerCase()) || 
    s.student_name?.toLowerCase().includes(search.toLowerCase()) ||
    s.class?.toLowerCase().includes(search.toLowerCase())
  );

  // Fix TypeScript type issue with Table columns
  const columns: ColumnsType<StudentActivity> = [
    {
      title: 'STT',
      key: 'index',
      render: (_, __, index) => index + 1,
      width: 70
    },
    {
      title: 'MSSV',
      dataIndex: 'student_id',
      key: 'student_id',
      sorter: (a, b) => (a.student_id || '').localeCompare(b.student_id || '')
    },
    {
      title: 'T√™n sinh vi√™n',
      dataIndex: 'student_name',
      key: 'student_name',
      sorter: (a, b) => (a.student_name || '').localeCompare(b.student_name || '')
    },
    {
      title: 'L·ªõp',
      dataIndex: 'class',
      key: 'class'
    },
    {
      title: 'Tr·∫°ng th√°i tham gia',
      key: 'participated',
      render: (_, record) => (
        <Tag color={record.participated ? 'green' : 'gray'}>
          {record.participated ? 'ƒê√£ tham gia' : 'Ch∆∞a tham gia'}
        </Tag>
      ),
      filters: [
        { text: 'ƒê√£ tham gia', value: true },
        { text: 'Ch∆∞a tham gia', value: false }
      ],
      onFilter: (value, record) => record.participated === !!value
    },
    {
      title: 'Thao t√°c',
      key: 'actions',
      render: (_, record) => (
        <div className="flex space-x-2">
          <Button 
            type="primary" 
            size="small" 
            onClick={() => handleToggleParticipated(record.student_id, !record.participated)}
          >
            {record.participated ? 'ƒê√°nh d·∫•u ch∆∞a tham gia' : 'ƒê√°nh d·∫•u ƒë√£ tham gia'}
          </Button>
          <Button 
            danger
            size="small" 
            onClick={() => handleRemoveStudent(record.student_id)}
          >
            X√≥a
          </Button>
        </div>
      )
    }
  ];

  // Fetch students not registered for this activity
  const fetchAvailableStudents = async () => {
    setLoadingAvailableStudents(true);
    try {
      const res = await api.get(`/api/student-activities/${activityId}/not-participated`);
      const allStudents = res.data.data.students || [];
      setAvailableStudents(allStudents);
    } catch (error) {
      console.error("Error fetching available students:", error);
      toast.error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch sinh vi√™n c√≥ th·ªÉ ƒëƒÉng k√Ω ‚ùå");
    } finally {
      setLoadingAvailableStudents(false);
    }
  };
  
  // Open register modal
  const openRegisterModal = () => {
    if (!canEdit) {
      const now = new Date();
      const registrationStart = activity?.registration_start ? new Date(activity.registration_start) : null;
      
      if (registrationStart && now < registrationStart) {
        toast.error("Ch∆∞a ƒë·∫øn th·ªùi gian ƒëƒÉng k√Ω");
      } else {
        toast.error("Th·ªùi gian ƒëƒÉng k√Ω ƒë√£ k·∫øt th√∫c");
      }
      return;
    }

    fetchAvailableStudents();
    setRegisterModalVisible(true);
  };
  
  // Handle student selection
  const toggleStudentSelection = (studentId: string) => {
    if (selectedStudents.includes(studentId)) {
      setSelectedStudents(selectedStudents.filter(id => id !== studentId));
    } else {
      setSelectedStudents([...selectedStudents, studentId]);
    }
  };
  
  // Register selected students
  const handleRegisterStudents = async () => {
    if (selectedStudents.length === 0) {
      toast.warning("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt sinh vi√™n");
      return;
    }

    if (!canEdit) {
      toast.error("Th·ªùi gian ƒëƒÉng k√Ω kh√¥ng h·ª£p l·ªá");
      setRegisterModalVisible(false);
      return;
    }
    
    try {
      await api.post(`/api/student-activities/${activityId}/students`, { 
        studentIds: selectedStudents 
      });
      
      setRegisterModalVisible(false);
      setSelectedStudents([]);
      toast.success("ƒêƒÉng k√Ω sinh vi√™n th√†nh c√¥ng üéâ");
      await fetchData(); // Refresh the list
    } catch (error) {
      console.error("Error registering students:", error);
      const apiError = error as { response?: { data?: { message?: string } } };
      const errorMessage = apiError.response?.data?.message || "ƒêƒÉng k√Ω sinh vi√™n th·∫•t b·∫°i ‚ùå";
      toast.error(errorMessage);
    }
  };
  
  // Handle removing a student from activity
  const handleRemoveStudent = (studentId: string) => {
    setStudentIdToDelete(studentId);
    setConfirmDeleteOpen(true);
  };
  
  // Confirm removal of student
  const confirmRemoveStudent = async () => {
    if (!studentIdToDelete) return;
    
    try {
      await api.delete(`/api/student-activities/${activityId}/students/${studentIdToDelete}`);
      toast.success("X√≥a sinh vi√™n kh·ªèi ho·∫°t ƒë·ªông th√†nh c√¥ng");
      await fetchData(); // Refresh the list
    } catch (error) {
      console.error("Error removing student:", error);
      toast.error("X√≥a sinh vi√™n th·∫•t b·∫°i");
    } finally {
      setConfirmDeleteOpen(false);
      setStudentIdToDelete(null);
    }
  };
  
  // Handle toggling participated status
  const handleToggleParticipated = async (studentId: string, participated: boolean) => {
    try {
      await api.patch(`/api/student-activities/${activityId}`, {
        studentId,
        participated,
      });
      toast.success("C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng");
      await fetchData(); // Refresh the list
    } catch (error) {
      console.error("Error updating participation status:", error);
      toast.error("C·∫≠p nh·∫≠t tr·∫°ng th√°i th·∫•t b·∫°i");
    }
  };

  if (loading) return <Loading />;

  if (error) {
    return (
      <div className="p-6">
        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
          <strong className="font-bold">L·ªói!</strong>
          <span className="block sm:inline"> {error}</span>
        </div>
        <button
          onClick={() => window.history.back()}
          className="px-4 py-2 cursor-pointer bg-rose-400 text-white rounded hover:bg-rose-700">
          Quay v·ªÅ danh s√°ch
        </button>
      </div>
    );
  }

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-4">
        {activity?.name || 'Chi ti·∫øt ho·∫°t ƒë·ªông'}
      </h1>

      <div className="bg-white rounded-lg shadow-md p-4 mb-6">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p className="text-gray-500">T√™n ho·∫°t ƒë·ªông:</p>
            <p className="font-medium">{activity?.name}</p>
          </div>
          <div>
            <p className="text-gray-500">ƒêi·ªÉm:</p>
            <p className="font-medium">{activity?.point}</p>
          </div>
          <div>
            <p className="text-gray-500">Phong tr√†o:</p>
            <p className="font-medium">{activity?.Campaign?.name || 'N/A'}</p>
          </div>
          <div>
            <p className="text-gray-500">Tr·∫°ng th√°i:</p>
            <p className="font-medium">
              <Tag color={activity?.status === 'ongoing' ? 'green' : 'gray'}>
                {activity?.status === 'ongoing' ? 'ƒêang di·ªÖn ra' : 'ƒê√£ k·∫øt th√∫c'}
              </Tag>
            </p>
          </div>
          <div>
            <p className="text-gray-500">B·∫Øt ƒë·∫ßu ƒëƒÉng k√Ω:</p>
            <p className="font-medium">
              {activity?.registration_start ? new Date(activity.registration_start).toLocaleDateString('vi-VN') : 'N/A'}
            </p>
          </div>
          <div>
            <p className="text-gray-500">K·∫øt th√∫c ƒëƒÉng k√Ω:</p>
            <p className="font-medium">
              {activity?.registration_end ? new Date(activity.registration_end).toLocaleDateString('vi-VN') : 'N/A'}
            </p>
          </div>
          <div>
            <p className="text-gray-500">Tr·∫°ng th√°i ph√™ duy·ªát:</p>
            <p className="font-medium">
              {activity?.approver_id !== null ? (
                <Tag color="green">ƒê√£ ph√™ duy·ªát</Tag>
              ) : (
                <Tag color="orange">Ch·ªù ph√™ duy·ªát</Tag>
              )}
            </p>
          </div>
        </div>
      </div>

      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-semibold">Danh s√°ch sinh vi√™n tham gia</h2>
        <div className="flex gap-4">
          {activity?.approver_id === null ? (
            <div className="px-4 py-2 bg-yellow-100 text-yellow-800 rounded">
              Ho·∫°t ƒë·ªông ƒëang ch·ªù ph√™ duy·ªát
            </div>
          ) : canEdit ? (
            <button
              className="px-4 py-2 cursor-pointer bg-green-600 text-white rounded hover:bg-green-700"
              onClick={openRegisterModal}>
              ƒêƒÉng k√Ω sinh vi√™n
            </button>
          ) : (
            <div className="px-4 py-2 bg-gray-100 text-gray-800 rounded">
              {new Date() < new Date(activity?.registration_start || '') 
                ? "Ch∆∞a ƒë·∫øn th·ªùi gian ƒëƒÉng k√Ω" 
                : "Th·ªùi gian ƒëƒÉng k√Ω ƒë√£ k·∫øt th√∫c"}
            </div>
          )}
          <button
            className="px-4 py-2 cursor-pointer bg-rose-400 text-white rounded hover:bg-rose-700"
            onClick={() => router.push('/uit/department-officers/activities')}>
            Quay v·ªÅ danh s√°ch
          </button>
        </div>
      </div>

      {activity?.approver_id === null ? (
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
          <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 mx-auto text-yellow-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <h3 className="text-lg font-medium text-yellow-800 mb-2">Ho·∫°t ƒë·ªông ƒëang ch·ªù ph√™ duy·ªát</h3>
          <p className="text-yellow-700">
            Danh s√°ch sinh vi√™n tham gia s·∫Ω hi·ªÉn th·ªã sau khi ho·∫°t ƒë·ªông ƒë∆∞·ª£c ph√™ duy·ªát. 
            Sinh vi√™n kh√¥ng th·ªÉ ƒëƒÉng k√Ω cho ho·∫°t ƒë·ªông ch∆∞a ƒë∆∞·ª£c ph√™ duy·ªát.
          </p>
        </div>
      ) : (
        <>
          <div className="mb-4">
            <Input.Search
              placeholder="T√¨m ki·∫øm theo MSSV, t√™n ho·∫∑c l·ªõp..."
              onChange={handleSearchChange}
              allowClear
              className="max-w-md"
            />
          </div>

          <div ref={tableRef} className="bg-white rounded-lg shadow overflow-hidden">
            <Table 
              columns={columns} 
              dataSource={filtered}
              rowKey="id"
              pagination={{ pageSize: 10 }}
              locale={{ emptyText: 'Kh√¥ng c√≥ sinh vi√™n n√†o' }}
            />
          </div>

          {/* Modal for registering students */}
          <Modal
            title="ƒêƒÉng k√Ω sinh vi√™n tham gia ho·∫°t ƒë·ªông"
            open={registerModalVisible}
            onCancel={() => setRegisterModalVisible(false)}
            footer={[
              <Button key="cancel" onClick={() => setRegisterModalVisible(false)}>
                H·ªßy
              </Button>,
              <Button 
                key="register" 
                type="primary" 
                onClick={handleRegisterStudents}
                disabled={selectedStudents.length === 0}
              >
                ƒêƒÉng k√Ω {selectedStudents.length > 0 ? `(${selectedStudents.length})` : ''}
              </Button>
            ]}
            width={800}
          >
            {loadingAvailableStudents ? (
              <Loading />
            ) : (
              <>
                <Input.Search
                  placeholder="T√¨m ki·∫øm sinh vi√™n..."
                  onChange={(e) => setSearchStudent(e.target.value)}
                  className="mb-4"
                />
                
                <div className="max-h-96 overflow-y-auto">
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ch·ªçn</th>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">MSSV</th>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">H·ªç t√™n</th>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">L·ªõp</th>
                      </tr>
                    </thead>
                    <tbody>
                      {availableStudents.filter(s => 
                        s.student_id?.toLowerCase().includes(searchStudent.toLowerCase()) || 
                        s.student_name?.toLowerCase().includes(searchStudent.toLowerCase()) ||
                        s.class?.toLowerCase().includes(searchStudent.toLowerCase())
                      ).length > 0 ? (
                        availableStudents.filter(s => 
                          s.student_id?.toLowerCase().includes(searchStudent.toLowerCase()) || 
                          s.student_name?.toLowerCase().includes(searchStudent.toLowerCase()) ||
                          s.class?.toLowerCase().includes(searchStudent.toLowerCase())
                        ).map((student) => (
                          <tr key={student.student_id} className="hover:bg-gray-50">
                            <td className="px-3 py-2">
                              <Checkbox 
                                checked={selectedStudents.includes(student.student_id)} 
                                onChange={() => toggleStudentSelection(student.student_id)}
                              />
                            </td>
                            <td className="px-3 py-2">{student.student_id}</td>
                            <td className="px-3 py-2">{student.student_name}</td>
                            <td className="px-3 py-2">{student.class}</td>
                          </tr>
                        ))
                      ) : (
                        <tr>
                          <td colSpan={4} className="text-center py-4">
                            {searchStudent 
                              ? 'Kh√¥ng t√¨m th·∫•y sinh vi√™n ph√π h·ª£p' 
                              : 'Kh√¥ng c√≥ sinh vi√™n n√†o c√≥ th·ªÉ ƒëƒÉng k√Ω'}
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </>
            )}
          </Modal>
          
          {/* Confirmation modal for deleting students */}
          <ConfirmDeleteModal
            isOpen={confirmDeleteOpen}
            onClose={() => setConfirmDeleteOpen(false)}
            onConfirm={confirmRemoveStudent}
          />
        </>
      )}
    </div>
  );
} 